<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://fonts.googleapis.com/css2?family=Cabin&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <title>Rapyd-Fyre Social Checkout Toolkit</title>
    <!-- <script src="https://checkouttoolkit.rapyd.net"></script> -->
    <script src="https://sandboxcheckouttoolkit.rapyd.net"></script>
    <script>
        const authToken = "";
        const emails = [];
        let checkout_id = localStorage.getItem("checkout_id")

        function addPayee(){
            const email = document.getElementById('email').value;
            if (email.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/) != null
                && !emails.includes(email)){
                emails.push(email);
                document.getElementById('email').value = "";
                initList();
            }
            else{
                alert("invalid or duplicate email");
            }
        }

        async function sendInvoiceDraft(email, amount){
            // let base = 'https://api-m.sandbox.paypal.com'
            // let invoice_num= base+'/v2/invoicing/generate-next-invoice-number'
            // console.log(invoice_num)
            // let invoice_num_resp =  await fetch(invoice_num, {
            //     method: "POST",

            //     headers: {
            //         Authorization: "Bearer A21AAIeB6SgrMub5cTnAXfZKkE9HRbBPHfLeNqchbDupvcV2Uy_3u0mgU7e7OupYsJhlFxOkaL4gSxZFybYA8DcppMvXkiL2w",
            //         "Content-Type": "application/json"

            //     }
            //     })
                
            // let inv_num = await invoice_num_resp.json()
            // console.log(inv_num.invoice_number);
            console.log(email)
            email = JSON.stringify(email)

            let _body = {
                
                detail: {
                    // "invoice_number": inv_num.invoice_number,
                    currency_code: "USD"

                },
                primary_recipients: [
                    {
                        billing_info: {
                            email_address: email
                        }
                    }
                ],
                items: [
                    {
                        name: "Yoga Mat",
                        description: "Elastic mat to practice yoga.",
                        quantity: "1",
                        unit_amount: {
                            currency_code: "USD",
                            value: amount
                        },
                        tax: {
                            name: "Sales Tax",
                            percent: 7.25
                        },
                        discount: {
                            percent: 5
                        },
                        unit_of_measure: "QUANTITY"
                    }
                ]
            
            }
            _body = JSON.stringify(_body)
            console.log(_body)

            // clientId = "AYsD3-tIM_xYfCoBK3A8PV4ZiPLKERi5YXsQ0BHyMubp9chijFarNtJN6VI9bq1Cr7uBw4PwkrukQMSu";
            let base_url = 'https://api-m.sandbox.paypal.com'
            let draft_invoice_url= base_url+'/v2/invoicing/invoices'
            let response = await fetch(draft_invoice_url, {
                headers: {
                    Authorization: authToken,
                    "Content-Type": "application/json",
                },
                method: "POST",
                body: _body
                });
            let data = await response.json();
            let link = data.href;
            let id = link.substring(link.lastIndexOf("/")+1);
            return id;
        }


        async function sendInvoice(){
            let base_url = 'https://api-m.sandbox.paypal.com'
            let draft_invoice_url= base_url+'/v2/invoicing/invoices'
            
            let splitVals = document.getElementsByClassName("split");

            for(let index = 0; index < emails.length; index++){ //iterate over all the emails and split values chosen

                if(parseFloat(splitVals[index].value) == NaN || parseFloat(splitVals[index].value) < 0){
                    splitVals[index].value = "0"; //set split amount to 0 by default if incorrect information is given
                }

                id = await sendInvoiceDraft(emails[index], parseFloat(splitVals[index].value));
                console.log(id);
                let send_invoice_url = draft_invoice_url + "/" + id + "/send"

                console.log(send_invoice_url)
                let _body = {
                    subject: "<The subject of the email that is sent as a notification to the recipient.>",
                    note: "<A note to the payer.>",
                    send_to_recipient: true,
                    send_to_invoicer: true
                }
                _body = JSON.stringify(_body)

                let send_inv = await fetch(send_invoice_url, {
                    method: "POST",
                    body: _body,
                    headers: {
                        Authorization: authToken,
                        "Content-Type": "application/json"
                    }
                    })
                let send_inv_resp = await send_inv.json()
                console.log(send_inv_resp)
                window.confirm("Succesfully issued");

            }          
        }

        function removePayee(email){
            emails.splice(emails.indexOf(email), 1);
            initList();
        }

        function initList(){
            const list  = document.getElementById('list');
            list.innerHTML = emails.map(i => 
                `<li>
                    ${i}
                    <span onclick="removePayee(this.id)" id="${i}" class="material-symbols-outlined">
                        close
                    </span>
                    <input type="text" class="split" placeholder="$ Amount">
                </li>`
            ).join('');
        }

        function enableSplit(){
            current = encodeURIComponent("https://rapyd-fyre.netlify.app/");
            clientId = "AYsD3-tIM_xYfCoBK3A8PV4ZiPLKERi5YXsQ0BHyMubp9chijFarNtJN6VI9bq1Cr7uBw4PwkrukQMSu";
            window.location.href = ("https://www.sandbox.paypal.com/connect/?flowEntry=static&client_id=" + clientId + "&response_type=code&scope=openid&redirect_uri=" + current)
        }

        function disableSplit(){
            document.getElementById("paypal-requests").style.display = "none";
            document.getElementById("splitSelect").style.display = "inline-block";
        }

        async function authPaypal(_code){
            let _body = {
                    grant_type: "authorization_code",
                    code: _code,
                }
            _body = JSON.stringify(_body)

            let auth = await fetch("https://api-m.sandbox.paypal.com/v1/oauth2/token", {
            body: "grant_type=authorization_code&code=" + _code,
            headers: {
                Authorization: "Basic QVlzRDMtdElNX3hZZkNvQkszQThQVjRaaVBMS0VSaTVZWHNRMEJIeU11YnA5Y2hpakZhck50Sk42Vkk5YnExQ3I3dUJ3NFB3a3J1a1FNU3U6RUNxM1Rhc0NjeHJhd01oUnMwZ1hxRU00enp0ZXdlY2NjYU1EalpmUElyYy1DNTc2M2NmWUp6ZEc4bk9vUjZjOEp1ZTdLOTBMUThmY1pFWDI=",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            method: "POST"
            })
            let auth_resp = await auth.json();
            console.log("access_token: " + auth_resp.access_token);
            authToken = "Bearer " + auth_resp.access_token;
        }

        window.onload = function () {   
            
            console.log("version5");
            initList();

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const code = urlParams.get('code');
            console.log(code);

            if(code != null){
                document.getElementById("paypal-requests").style.display = "inline-block";
                document.getElementById("splitSelect").style.display = "none";
                authPaypal(code);
            }

            let checkout_url = ""
            
            // fetch("https://ipinfo.io/json")

            let checkout = new RapydCheckoutToolkit({
                pay_button_text: "Click to pay",
                pay_button_color: "red",
                id: checkout_id
            });
            checkout.displayCheckout();
        }

        window.addEventListener('onCheckoutPaymentSuccess', function (event) {
            console.log('hi')

            // const base_url = 'https://api-m.sandbox.paypal.com'
            // const draft_invoice = base_url+'/v2/invoicing/invoices'
            // //const send_invoice = base_url + /v2/invoicing/invoices/INV2-LVXF-JJT2-QFBP-AJVQ/send
            // $.getJSON(draft_invoice, function(result){
            //     console.log(result)
            // });

            //THIS IS WHERE sendInvoice() WOULD BE CALLED //////////////////////////////////////////////////////////////////////////////////////////////////////////////
            sendInvoice();
            console.log(event.detail)
        });

        window.addEventListener('onCheckoutFailure', function (event) {
            console.log(event.detail.error)
        });

    </script>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <h1>Rapyd-Fyre Social Checkout Toolkit</h1>
    
    <div id="paypal-requests">
        <ul id="list"></ul>
        <input type="text" id="email">
        <button onclick="addPayee()" id="addbutton">Add Payee</button>
        <button onclick="disableSplit()" id="splitDeselect">Cancel Split</button>
    </div>
    <div id="sizing-box">
        <button onclick="enableSplit()" id="splitSelect">Split with Paypal</button>
    </div>
    <br>   
    <div style="width: 500px" id="rapyd-checkout"></div>

</body>

</html><!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="logo.svg" type="image/png" sizes="16x16">

    <title>Bikes.com - City 2022</title>

    <script>
        const checkout_id_array = [
            "checkout_54020b31014f1e24e5e50dd0fb57b73a",
            "checkout_8a1a837e06d9466a6fb72f8d591b2165",
            "checkout_f3498c7b23c22d989eb415813c045655",
            "checkout_1fb62a07a6bffd786b8f59a2bf9912b3",
            "checkout_c3d045e41e801b82aaf6d4200037207a",
            "checkout_0afb60c093c0146a6f29cba4cc7e0688",
            "checkout_7226aacb6add797da0e84a2b59c7c891",
            "checkout_24a2d41f766b268a3013319b35d4f932",
            "checkout_a240515809c5376dae2ae310d30bdc89",
            "checkout_8559cf883c6798245730786d6e47b1a7",
            "checkout_74b20eb9a9f5738e3fd364f736d0953d",
            "checkout_33571fcf84bba14a11562b1c72ed3e8c",
            "checkout_c28d39b8ab7c4d2d1d8c700418dbec47",
            "checkout_121536811488cad825984c6726718408",
            "checkout_7b56aabc81376a0466cd929453172820",
            "checkout_5a7d91e99d39536e235f3e286e636a8d",
            "checkout_403627e6313332133a8b194d61197409",
            "checkout_4127c9b6fd8124ea4fdc05f594d5d753",
            "checkout_bd959ddea6f27a7f959782442df99768",
            "checkout_02e199510529fa84d5cb69772c521409",
            "checkout_e39161a2c227630c8ba11abc1c0b612c",
            "checkout_33d76661e31243267210a9ecf4578c29",
            "checkout_8f7997f31c71a892870260e77037589a",
            "checkout_d75efab86739ff75f9115357e24b898d",
            "checkout_3ef9a772b13b436735feba02bc9ef77b",
            "checkout_46f54e647793ca3c1430911dbbe9304f",
            "checkout_4a28349f30bc592458a7538948b49417",
            "checkout_3259388a43666c3d0a8218cd7490a37a",
            "checkout_181651991e0aa5ad889c33c578a32f84",
            "checkout_300d267eabb98a04351e499ba6b8a821",
            "checkout_ac0d0279d2a93acf1f1176fbbd78072b"
        ]

        window.onload = () => {
            localStorage.setItem('checkout_id', checkout_id_array[Math.floor(Math.random() * checkout_id_array.length)]);
        }
    </script>
</head>

<body>
    <div>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="bike.html">
                    <img src="logo.svg" alt="" height="42">
                </a>
                <a class="navbar-brand" href="bike.html">Bikes.com</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="bike.html">Shop</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Contact us</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="row justify-content-center my-5">
                <div class="col-md mb-4">
                    <img src="bike-img.jpeg" class="img-thumbnail border-0">
                </div>
                <div class="col-md">
                    <h1>City 2021</h1>
                    <h2 style="color: #F7785A">$750.00</h2>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Aliquid quaerat autem voluptate optio excepturi quis earum neque qui asperiores? Enim sit dolor recusandae natus pariatur, non obcaecati illum veritatis eveniet.</p>
                    <div class="alert alert-warning" role="alert">
                        Shipping restrictions apply!
                    </div>
                    <!-- <a role="button" class="btn btn-lg btn-custom" href="index.html">Buy Now</a> -->
                    <form action="index.html">
                        <input  class="btn btn-lg btn-custom" type="submit" value="Buy Now" />
                    </form>
                    <a href="#" class="ms-2 link-secondary">Return policy</a>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row justify-content-center text-center border-top py-2">
                <span>&copy;2021. Rapyd Checkout Toolkit Integration demo site.</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

</body>
</html>